\chapter{Realisierung}
\section{Modellierung}
Blenderplugin, IFCWallTypes Module die das Raster vorgeben etc.

\section{Wall Detailing}
Als \glqq{}Wall Detailing\grqq{} (sprich das \glqq{}Detailieren von Wänden\grqq{}) wird in dieser Arbeit der Vorgang ein als geometrischer Körper definiertes Wandstück in ein konkretes Mauerwerk zu überführen, bezeichnet.
Innerhalb des IFC Standards werden einige mathematische/geometrische Repräsentationen der sogennanten \textit{IFCWall} unterstützt, um neben einfachen Boxen auch komplexere Formen abbilden zu können.
Beispielsweise ist es möglich in das Modell eines Hauses zunehmend dünner werdende Wandstücke, kurvige Wandstücke oder Wandstücke, welche nur durch ein arbiträres Vieleck beschrieben werden können zu integrieren.
Allerdings ist es für die Fallstudien dieser Arbeit zunächst ausreichend nur Wandstücke, welche als einfacher geometrischer Quader vorliegen, zu beachten.
Das nachfolgende schrittweise Vorgehen weist aufgrund des annähernd gleichen Ergebnisses zwangsläufig Ähnlichkeiten zu dem von Usmanov et al. auf \cite{Usmanov2021}.

\subsection{Konvertieren des IFC zu BREP}
Den ersten Schritt stellt das Extrahieren aller notwendigen Daten aus dem vorliegenden IFC Modell dar.
Für die Fallstudien dieser Arbeit sind sowohl alle Objekte des Typs \textit{IFCWall} als auch die, etwa durch Fenster oder Türen entstehenden, daran angeknüpften Objekte vom Typ \textit{IfcOpeningElement} (siehe \ref{basics:IfcOpeningElement}) von Interesse.
Zusätzlich werden aus den, in den \textit{IfcPropertySets} der Wandstücke hinterlegten Daten, Informationen über das zu verwendende Modul ausgelesen.
Mithilfe der Werkzeuge der in Kapitel \ref{basics} vorgstellten Python Bibliothek \textit{ifcopenshell} (siehe \ref{basics:ifcopenshell}) ist dies intuitiv möglich.
TODO Sätze zum Code, Code TODO kleines Klassendiagram von Wall/WallLayerGroup und Opening und BrickInformation

\subsection{Überprüfen der modellierten Wände}
\subsubsection{Filtern}
Da sich diese Arbeit zunächst ausschließlich mit quaderförmigen Wandstücken beschäftigt, müssen zunächst alle zuvor aus dem IFC Modell extrahierten Wandstücke auf diese Eigenschaft geprüft werden.
Somit ist gewährleistet, dass lediglich passende Wandstücke an die nachfolgenden Schritte weitergegeben werden.
TODO Satz zum Code, Code iscubic

\subsubsection{Anwenden des Moduls}
Mit dem zu jedem Wandstück festgelegten Modul werden nun alle Wandstücke in Schichten aufgeteilt.
Deren Höhe entspricht im Normalfall der Höhe des jeweilgen Moduls.
Lediglich die oberste Schicht kann durch falsch modellierte Wandstücke eine niedrigere Schichthöhe aufweisen.
Dies ist der Fall, wenn die Gesamthöhe des Wandstücks nicht exakt einem Vielfachen der Höhe des Moduls entspricht und ein nicht aufzuteilender Rest existiert.
Das Aufteilen in Schichten erleichtert es im Anschluss Berechnungen an Wandstücken durchzuführen und Beziehungen zwischen ihnen zu finden.

\subsubsection{Kombinieren passender Wandstücke}
Eine solche Beziehung stellen etwa Wandstücke dar, die zwar in dem Modellierungsprozess des Gebäudes durch mehrere einzelne Objekte realisiert wurden, eigentlich aber eine Einheit darstellen.
Daher werden in diesem Schritt alle Wandstücke miteinander verglichen und eventuell kombiniert, sodass jeweils ein gefundes Paar durch ein einzelnes Wandstück representiert wird.
Um zwei Wandstücke zu kombinieren müssen folgende Eigenschaften gelten:
\begin{figure}[htb]
    \centering
    \begin{subfigure}[b]{0.9\columnwidth}
      \includegraphics[width=\columnwidth]{fig/Real_Combination_Base.png}
      \caption{Eingabe eines Modells mit 6 Wänden.}
      \label{fig:real:combination_example_base}
    \end{subfigure}
    \begin{subfigure}[b]{0.9\columnwidth}
      \includegraphics[width=\columnwidth]{fig/Real_Combination_Output.png}
      \caption{Ergebnis mit 71 Ziegeln.}
      \label{fig:real:kreuzcombination_example_solution}
    \end{subfigure}
    \label{fig:real:combination_example}
    \caption{Beispiel mit einigen kombinierbaren Wänden.}
\end{figure}

\begin{enumerate}
    \item Beide Wandstücke verwenden das selbe Modul und sind während der Modellierung mit den gleichen Wandtyp annotiert worden. 
    Dies verhindert vor allem das Kombinieren unterschiedlich dicker Wände.
    \item\label{real:z_parallel} Die lokalen Z-Achsen beider Wandstücke sind parallel. 
    Dies verhindert das Kombinieren unpassend rotierter Wandstücke.
    Die Überprüfung der Parallelität der Z-Achsen beider Wandstücke wird wie folgt durchgeführt:

    Sei
    \(\vec{v}_z = {[0, 0, 1]}^T\)
    die Z-Achse und \(v_z = (0, 0, 0, 1)\) das dazugehörige Quaternion. 
    Außerdem seien \(q_1\) und \(q_2\) die beiden Rotationen der Wandstücke. Dann stellen 
    \(\vec{v}_{z^1} = q_1 * v_z * q_1^{-1}\) und 
    \(\vec{v}_{z^2} = q_2 * v_z * q_2^{-1}\) die jeweiligen \glqq{}Z-Vektoren\grqq{} dieser Rotationen dar.
    Ist nun \(|\vec{v}_{z^1} \cdot \vec{v}_{z^2}| = 1\) gegeben, so sind die lokalen Z-Achsen der Wandstücke gleich oder um exakt 180\degree{} verdreht und damit Parallelität erfüllt.
    \item Die lokalen X-Achsen beider Wandstücke sind ebenfalls parallel. Das Vorgehen zur Überprüfung entspricht dem von Punkt~\ref{real:z_parallel}, nur dass \(v_z\) durch \(v_x = (0, 1, 0, 0)\), also der X-Achse, ersetzt werden muss.
    \item Sie stehen auf der selben Höhe oder versetzt um ein Vielfaches der gemeinsamen Modulhöhe.
    \item\label{real:schichten} Mindestens eine Schicht des einen Wandstücks berührt, überlappt oder befindet sich exakt eine Modulöhe ober- oder unterhalb einer Schicht des anderen Wandstücks.
\end{enumerate}

In Abbildung~\ref{fig:real:combination_example_base} treten verschiedene Fälle von Wandstücken auf, die miteinander kombiniert werden müssen.
TODO: Bild Nummerieren
Fall Überlappung und komplette Überlappung
Fall Übereinander (TODO, modell nochmal anpassen...)
Fall Nebeneinader
Fall unten rechts -> kein Fall
Während dem Kombinieren von zwei Wänden, wird ein Wandstück schichtweise in das andere überführt.
Dabei werden alle Schichten paarweise miteinader verglichen, um diejenigen Paare zu finden, die die Eigenschaften aus Punkt~\ref{real:schichten} erfüllen.
Ein solches Paar wird dann wie folgt miteinander verschmolzen:
TODO erklärung Code

Steht ein Wandstück in X-Richtung versetzt auf einem anderem, so ist es notwendig diesen Versatz während dem nachfolgenden Detailing zu berücksichtigen.
Ignoriert man diesen Versatz kann das zu den in Abbildung TODO gezeigten Fehlern führen.
Dieser, nachfolgend als \textit{x\_offset} bezeichnete Versatz ist definiert durch die Differenz zwischen der kleinsten lokalen X-Koordinate aller Schichten eines Wandstückes und der lokalen X-Koordinate der zu betrachtenden Schicht.
Der daraus resultierende Wert wird später dazu verwendet den anzuwendenden Mauerwerksverband erst an der passenden Stelle zu beginnen.
Dadurch erzielt man einen einheitlichen Verband über das gesamte Wandstück und verhindert den in Abbildung TODO gezeigten Fehlerfall.
Eine weitere Eigenschaft, die aus dem Kombinieren mehrerer Wandstücke entstehen kann, ist das vorhandensein unterbrochender Schichten beziehungsweise mehrerer Schichten auf einer Höhe innerhalb eines Wandstückes.
Dies ist ebenfalls in Abbildung TODO dargestellt.
Durch das Einbeziehen des \textit{x\_offset} können derartige Situationen jedoch ebenfalls gelöst werden, da für jedes Teilstück einer Schicht ein eigener \textit{x\_offset} berechnet wird.
Auch dies ist der Abbildung TODO zu entnehmen.

\subsubsection{Beziehungen finden}
Nun wird die aus dem vorherigen Schritt entstandene neue Menge an Wandstücken auf weitere Beziehungen untersucht.
Für das Wall Detailing relevante Beziehungen stellen Ecken, T-Kreuzungen und X-Kreuzungen dar (siehe \ref{basics:Mauerwerksverband}).
Der Grund dafür ist die Komplexität in diesen Bereichnen die vorgeschriebenen Normen (wie etwa dem in Abschnitt~\ref{basics:Mauerwerksverband} genannten Überbindemaß) einzuhalten.
Deswegen existieren für jeden Mauerwerksverband eigene spezielle Eck- und Kreuzungslegepläne, die an diesen Stellen eingefügt werden müssen.
Es werden wie oben nur die Wandstücke miteinander verglichen, die mit dem selben Wandtyp annotiert wurden und das gleiche Modul verwenden.
Die drei Beziehungen ähneln sich stark und besitzen demnach einige geteilte Eigenschaften:
\begin{enumerate}
    \item Die lokalen Z-Achsen beider Wandstücke sind parallel.
    \item Sie stehen auf der selben Höhe oder versetzt um ein Vielfaches der gemeinsamen Modulhöhe.
    \item Mindestens eines der beiden Wandstücke endet auf einem anderen, sodass mindestens eine Schicht das andere Wandstück direkt berührt.
\end{enumerate}
Sind diese Eigenschaften erfüllt, werden für jede durch die einzelnen Schichten der Wandstücke vorgegebene Höhe Schnittpunkte zwischen den beiden Wandstücken errechnet.
Im Falle einer einfachen Ecke oder einer T-Kreuzung, existiert nur ein einzelnes Paar an Wandstücken, deren Schichten sich in jedem Höhenschritt des Moduls im Mittelpunkt der Ecke schneiden.
Der Unterschied ist lediglich die Stelle des Schnittpunkts relativ zu den beiden Wandstücken.
Liegt der errechnete Schnittpunkt bei beiden Wandstücken näher als Wandbreite/2 an einer der beiden Außenkanten handelt es sich um eine Ecke.
Falls der Schnittpunkt bei einem der beiden Wandstücke allerdings mindestens Wandbreite/2 innerhalb des Wandstücks liegt, so handelt es sich um eine T-Kreuzung.
Werden für zwei unterschiedliche Paare die selben Schnittpunkte errechnet, so kann es sich entweder um eine mit drei Wandstücken modellierte T-Kreuzung oder X-Kreuzung handeln.
Teilen sich zwei T-Kreuzungen die selben Schnittpunkte, so sind alle Vorraussetzungen für eine eine X-Kreuzung gegeben.
Liegt der Schnittpunkt des Wandstück-Paares mindesten Wandbreite/2 innerhalb beider Wandstücke, so handelt es sich um eine X-Kreuzung - modelliert aus zwei sich schneidenden Wandstücken. 
TODO Bilder

\subsection{Lösen der Beziehungen}
Je nach gewählten Verband müssen z.B. Ecken (deren Baupläne im vornherein definiert wurden) so angeordnet werden, dass die dazwischenliegenden Wandstücke lückenlos eingefüllt werden können.
Dafür muss ein sogenannter "plan\_offset" für jede Wand und jede Ecke gefunden werden. Dieser gibt an, an welchem Index der Bauplandefinition das Wandstück (von unten) beginnen muss, um insgesamt einen einheitlichen Wandkörper ohne Lücken zu bilden.
Voraussetzung dafür ist natürlich ein passender Eckplan zu dem gewählten Verband. 

Schwierigkeiten: Eckpläne insgesamt, Ecken ragen in die sie bildenden Wände hinein. Diese müssen dementsprechend verkleinert werden.

\subsection{Anwenden der Lösung}
Ablaufen aller Ecken und Wände und einsetzen der Ziegel gemäß den gefundenen Lösungen.

\subsection{Export}
Abhängigkeitsgraph und Ontologie für Regelwerk