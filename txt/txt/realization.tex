\chapter{Realisierung}
Mit dem in Kapitel~\ref{basics:ifc} vorgestellten \textit{IFC Standard} existiert ein umfangreiches Framework zur Beschreibung sämtlicher für die Baubranche relevanter Daten. 
Im Zusammenspiel mit dem darauf aufbauenden \textit{Building Information Modelling} wird ein einheitliches Verwaltungskonzept für das Planen, Bauen und Bewirtschaften von Infrastrukur vorgeschlagen (siehe Kapitel~\ref{basics:bim}).
Darum stellen im IFC Format vorliegende Gebäudepläne den Ausgangspunkt dieser Arbeit dar.

\section{Modellierung}
Dank den in Kapitel~\ref{basics:ifcopenshell} vorgstellten Open Source Projekten zu den Technologien \textit{IFC} und \textit{BIM} sowie deren Anbindungen an die ebenfalls öffentliche 3D-Grafiksoftware Blender (siehe Kapitel~\ref{basics:blender}) ist es möglich auf einen komplett kostenlosen Technologiestack zur Modellierung von Gebäuden im IFC Format zurückzugreifen.
Die Option Blender mithilfe sogennanter \textit{Addons} an spezielle projektabhängige Anforderungen anzupassen, macht diese Modellierungsumgebung noch zweckdienlicher.
Ein solches Addon ist zum Beispiel \textit{blenderbim}. 
Dieses ermöglicht es ein IFC Projekt direkt in Blender entweder neu zu beginnen oder ein vorhandenes zu bearbeiten.
Für diese Arbeit relevant ist zunächst das Erstellen und Annotieren von Wänden beziehungsweise Wandtypen, sowie das Anbringen von Öffnungen.
Beide Konzepte sind Teil des IFC Standards und wurden bereits ausführlich in Kapitel~\ref{basics:ifc} vorgestellt.
Blenderbim ermöglicht es in wenigen Schritten einen neuen \textit{IFCWallType} zu definieren und daraus \textit{IFCWall} Objekte zu erstellen.
Diese können mit den von Blender nativ angebotenen Werkzeugen angepasst werden.
Zusätzlich gibt es weitere hilfreiche von Blenderbim eingeführte Modellierungsmöglichkeiten.
Dank der Möglichkeit eigene \textit{IFCProperties} (siehe Kapitel~\ref{basics:ifc_properties}) zu definieren, lassen sich die in Kapitel~\ref{concept:raster} konzeptionierten Raster- und Modulinformationen zu den neu definierten Wandtypen hinzufügen.
Bei Generierung eines \textit{IFCWall} Objekts werden diese Properties ebenfalls an das neue konkrete Wandstück geknüpft.
Damit können diese Informationen sowohl an das nachfolgende Wall Detailing übermittelt, als auch zur intuitiveren Modellierung des 3D Modells herangezogen werden, indem man Nutzern durch ein für diese Arbeit entwickeltes Addon das für jeden Wandtyp zugeordnete Raster bei sämtlichen Transformationsvorgängen aufzwingt.
Dadurch werden kleine Modellierungsfehler von vornherein vermieden.

\section{Wall Detailing}
In Abschnitt~\ref{concept:wall_detailing} wurde das Wall Detailing als der Vorgang, ein als geometrischer Körper definiertes Wandstück in ein konkretes Mauerwerk zu überführen, bezeichnet.
Innerhalb des IFC Standards werden einige mathematische/geometrische Repräsentationen der sogennanten \textit{IFCWall} unterstützt, um neben einfachen Boxen auch komplexere Formen abbilden zu können.
Beispielsweise ist es möglich in das Modell eines Hauses zunehmend dünner werdende Wandstücke, kurvige Wandstücke oder Wandstücke, welche nur durch ein arbiträres Vieleck beschrieben werden können zu integrieren.
Standardmäßig haben \textit{IFCWalls} aber einen einfachen Quader als Grundform, was für die Fallstudien dieser Arbeit ausreichend ist.
Die Unterkapitel dieses Abschnitts folgen den in Kapitel~\ref{concept:wall_detailing} genannten Schritten, um von einer Menge solcher Wände hin zu einer Menge an Bausteinen zu gelangen, die den gewünschten Mauerwerksverband darauf anweden.

\subsection{Konvertieren des IFC zu BREP}
Den ersten Schritt stellt das Extrahieren aller notwendigen Daten aus dem vorliegenden IFC Modell dar.
Für die Fallstudien dieser Arbeit sind sowohl alle Objekte des Typs \textit{IFCWall} als auch die, etwa durch Fenster oder Türen entstehenden, daran angeknüpften Objekte vom Typ \textit{IfcOpeningElement} (siehe~\ref{basics:IfcOpeningElement}) von Interesse.
Zusätzlich werden aus den, in den \textit{IfcPropertySets} der Wandstücke hinterlegten Daten, Informationen über das zu verwendende Modul und Raster ausgelesen.
Mithilfe der Werkzeuge der in Kapitel~\ref{basics} vorgstellten Python Bibliothek \textit{ifcopenshell} (siehe~\ref{basics:ifcopenshell}) ist dies in wenigen Schritten möglich.

\begin{lstlisting}[language=Python, caption=Extraktion relevanter Informtionen aus einem IFC-File.]
TODO Saetze zum Code, Code TODO kleines Klassendiagram von 
Wall bzw WallLayerGroup und Opening und BrickInformation
\end{lstlisting}

Da sich diese Arbeit zunächst ausschließlich mit quaderförmigen Wandstücken beschäftigt, müssen alle zuvor aus dem IFC Modell extrahierten Wandstücke auf diese Eigenschaft geprüft werden.
Somit ist gewährleistet, dass lediglich passende Wandstücke an die nachfolgenden Schritte weitergegeben werden.


\begin{lstlisting}[language=Python, caption=Überprüfen der extrahierten Wandstücke auf Quaderförmigkeit.]
  TODO Satz zum Code, Code iscubic
\end{lstlisting}

\subsection{Anwenden des Moduls}
Mit dem zu jedem Wandstück festgelegten Modul werden nun alle Wandstücke in Schichten aufgeteilt.
Deren Höhe entspricht im Normalfall der Höhe des jeweilgen Moduls.
Lediglich die oberste Schicht kann durch falsch modellierte Wandstücke eine niedrigere Schichthöhe aufweisen.
Dies ist der Fall, wenn die Gesamthöhe des Wandstücks nicht exakt einem Vielfachen der Höhe des Moduls entspricht und ein nicht aufzuteilender Rest existiert.
Das Aufteilen in Schichten erleichtert es im Anschluss Berechnungen an Wandstücken durchzuführen und Beziehungen zwischen ihnen zu finden.

\subsection{Kombinieren passender Wandstücke}
\label{real:combination}
Eine solche Beziehung stellen Wände dar, die, wie bereits in Kapitel~\ref{concept:relations_wandtuecke} definiert, durch mehrere einzelne Objekte modelliert wurden, eigentlich aber eine Einheit bilden.
Daher werden in diesem Schritt alle Wandstücke miteinander verglichen und eventuell kombiniert, sodass jeweils ein gefundes Paar durch ein einzelnes Wandstück repräsentiert wird.
Um zwei Wandstücke zu sinvoll kombinieren zu können, müssen die Eigenschaften aus Kapitel~\ref{concept:combination_properties} gelten.
Allerdings kann Punkt~\ref{concept:schichten}, welcher Berührung oder Überlappung voraussetzt mittlerweile wie folgt verschärft werden:

\begin{enumerate}
\setcounter{enumi}{4}
\item\label{real:schichten} Mindestens eine Schicht des einen Wandstücks berührt, überlappt oder befindet sich exakt eine Modulöhe ober- oder unterhalb einer Schicht des anderen Wandstücks.
\end{enumerate}

In Abbildung~\ref{fig:concept:combination_example_base} treten verschiedene Konstellationen von Wandstücken auf, die miteinander kombiniert werden müssen.
Das aus Wandstück 1 und 2 gebildete Paar erfüllt alle oben genannten Eigenschaften und weist eine Teil-Überlappung auf.
Somit müssen beide Wandstücke miteinader kombiniert werden.
Den obersten Bereich füllen sowohl Wandstück 5 als auch Wandstück 6, sodass dort eine komplette Überlappung vorliegt.
Auch diese beiden Wandstücke werden kombiniert, wobei dabei im Prinzip einfach eines verworfen wird.
Zusätzlich muss dieser Bereich, wie auch Wandstück 7, mit Wandstück 2 kombiniert werden, da die beiden Paare sich an Ober- und Unterkante berühren.
Einen weiteren Fall stellen seitliche, nicht überlappende Berührungen dar, wie sie zwischen Wandstück 2 und 3 zu sehen ist.
Auch für dieses Paar sind alle Voraussetzungen zur Fusion erfüllt.
Lediglich Wandstück 4 muss nicht mit dem Rest vereint werden, da dafür kein Paar existiert, das die obrigen Eigenschaften erfüllt.
Anhand von Abbildung~\ref{fig:real:combination_example_solution_xoffset} kann man erkennen, dass Wandstück 4 im weiteren Verlauf des Detailings tatsächlich unabhängig betrachtet werden kann. 

Während dem Kombinieren von zwei Wänden, wird ein Wandstück schichtweise in das Andere überführt.
Dabei werden alle Schichten paarweise miteinader verglichen, um diejenigen Paare zu finden, die die Eigenschaften aus Punkt~\ref{real:schichten} erfüllen.
Ein solches Paar wird dann wie folgt miteinander verschmolzen:

\begin{lstlisting}[language=Python, caption=Pseudocode zur Vereinigung zweier sich berührender oder überlappender Schichten von zwei nach den Voraussetzungen aus Abschnitt~\ref{concept:combination_properties} kombinierbaren Wandstücken.]
  def combine(layer1, layer2):
    # get the local positions of both edges of layer1 as 3D array
    left_edge1 = layer1.get_left_edge(relative=True)
    right_edge1 = layer1.get_right_edge(relative=True)

    # get the position of both edges of layer 2 relative to the coordinate systsem of layer1 as 3D array
    left_edge2 = layer2.get_left_edge(relative=False)
    left_edge2 = layer1.relative_position_of(left_edge2)

    right_edge2 = layer2.get_right_edge(relative=False)
    right_edge2 = layer1.relative_position_of(righ_edge2)

    # get the total length both layers cover by subtracting max - min of the x coordinates
    max_x = max(left_edge1[0], right_edge1[0], left_edge2[0], right_edge2[0]) 
    min_x = min(left_edge1[0], right_edge1[0], left_edge2[0], right_edge2[0]) 
    total_length = max_x - min_x

    # calculate the center of the resulting layer
    left = min([left_edge1, right_edge1, left_edge2, bright_edge22], key=lambda x: x[0])
    local_center = left.copy()
    local_center[0] += total_length / 2.0

    # convert to global coordinates and return new layer
    center = layer1.global_position_of(local_center)
    return Layer(center, total_length)

\end{lstlisting}

TODO erklärung Code

\begin{figure}[ht!]
  \centering
  \includegraphics[width=0.8\columnwidth]{fig/Real_Combination_Output.png}
  \caption{Ergebnis mit berücksichtigtem \textit{x\_offset}.}
  \label{fig:real:combination_example_solution_xoffset}
\end{figure}

\begin{figure}[hb!]
  \centering
  \includegraphics[width=0.8\columnwidth]{fig/Real_Combination_Output_No_XOffsetpng.png}
  \caption{Ergebnis mit ignoriertem \textit{x\_offset}.}
  \label{fig:real:combination_example_solution_no_xoffset}
\end{figure}

Steht ein Wandstück in X-Richtung versetzt auf einem anderem, so ist es notwendig diesen Versatz während dem nachfolgenden Detailing zu berücksichtigen.
Ignoriert man dies, kann das zu den in Abbildung~\ref{fig:real:combination_example_solution_no_xoffset} gezeigten Fehlern (zum Beispiel zwischen Wandstück 2 und 7) innerhalb des Mauerwerksverbands und damit ebenfalls zu Verletzungen des vorgeschriebenen Überbindemaßes führen (siehe Abschnitt~\ref*{basics:Mauerwerksverband}).
Dieser, nachfolgend als \textit{x\_offset} bezeichnete Versatz ist definiert als die Differenz zwischen der kleinsten lokalen X-Koordinate aller Schichten eines Wandstückes und der lokalen X-Koordinate der zu betrachtenden Schicht.
Der daraus resultierende Wert wird später dazu verwendet den anzuwendenden Mauerwerksverband erst an passender Stelle zu beginnen.
Dadurch erzielt man einen einheitlichen Verband über das gesamte Wandstück und verhindert den in Abbildung~\ref{fig:real:combination_example_solution_no_xoffset} gezeigten Fehlerfall.
Eine weitere Eigenschaft, die aus dem Kombinieren mehrerer Wandstücke entstehen kann, ist das vorhandensein unterbrochender Schichten oder, anders ausgedrückt, mehrerer Schichten auf einer Höhe innerhalb des resultierenden Wandstückes.
Dies ist ebenfalls in Abbildung~\ref{fig:concept:combination_example_base} zu sehen. 
Zwischen drei Schichten des Bereichs der Wandstücke 5 und 6 und des Wandstücks 7 ist eine Lücke.
Durch das Einbeziehen des \textit{x\_offset} können derartige Situationen jedoch ebenfalls gelöst werden, da für jedes Teilstück einer Schicht ein eigener \textit{x\_offset} berechnet wird.

Nach Vereinigung aller passenden Paare reduziert sich die Zahl der ursprünglichen Wandstücke aus dem Modell in Abbildung~\ref{fig:concept:combination_example_base} von 7 auf 2.

\subsection{Finden und Lösen von Beziehungen}
Nun wird die aus dem vorherigen Schritt entstandene neue Menge an Wandstücken auf weitere Beziehungen untersucht.
Für das Wall Detailing relevante Beziehungen stellen Ecken, T-Kreuzungen und X-Kreuzungen dar (siehe~\ref{concept:solving_beziehungen}).
Der Grund dafür ist die Komplexität in diesen Bereichnen die vorgeschriebenen Normen (wie etwa das in Abschnitt~\ref{basics:Mauerwerksverband} genannte Überbindemaß) einzuhalten.
In Abschnitt~\ref{concept:corner_etc_properties} wurden bereits die Eigenschaften aufgeführt, mithilfe derer sich die gesuchten Beziehungen identifizieren lassen.
Die wichtigsten Informationen für jede dieser Beziehungen ist einerseits der Punkt, an dem sie sich im Raum befindet, andererseits die Art der Beziehung (also ob es sich um eine Ecke, T- oder X-Kreuzung handelt).
Die Position ist der Schnittpunkt der Richtungsvektoren entlang der lokalen X-Achsen beider Wandstücke.
Die Unterscheidung der Beziehungen kann mithilfe des Vorgehens, das ebenfalls in Abschnitt~\ref{concept:corner_etc_properties} erläutert wurde, gemacht werden.
Dabei spielen die Anzahl der Wandstücke, die sich in einem Punkt schneiden und der Ort des Punktes innerhalb der beteiligten Wandstücke eine Rolle.
Da ein Wandstück zu diesem Zeitpunkt schon als Menge an Schichten vorliegt, wird das Verfahren, wie es bereits oben getan wurde, paarweise auf alle Schichten angewandt.
Somit werden für jede, sich durch Verkettungen über mehrere Wandstücke erstreckende Schicht alle Kreuzungs- und Eckbereiche ausfindig gemacht.
Bevor aber ein neues \glqq{}Eckobjekt\grqq{} angelegt wird, wird überprüft, ob an dem errechneten Schnittpunkt bereits ein Eckbereich gefunden wurde und das dazu gehörende Eckobjekt in dem Fall um eine neue Schicht erweitert.
Außerdem kann im selben Schritt bereits die Zuweisung der Art der Beziehung vorgenommen werden.
Durch die Eckobjekte werden nun die bis dahin unabhängigen Wandstücke, welche durch den vorherigen Schritt bereits schichtweise und kombiniert vorliegen, miteinader verknüpft.
TODO Klassendiagramm

Durch diese schichtweise Betrachtung wird automatisch das korrekte Auffinden von Ecken zwischen zwei unterschiedlich hohen Wandstücken ermöglicht.

\subsection*{Lösen der Beziehungen}
Je nach gewählten Verband müssen z.B. Ecken (deren Baupläne im vornherein definiert wurden) so angeordnet werden, dass die dazwischenliegenden Wandstücke lückenlos eingefüllt werden können.
Dafür muss ein sogenannter "plan\_offset" für jede Wand und jede Ecke gefunden werden. Dieser gibt an, an welchem Index der Bauplandefinition das Wandstück (von unten) beginnen muss, um insgesamt einen einheitlichen Wandkörper ohne Lücken zu bilden.
Voraussetzung dafür ist natürlich ein passender Eckplan zu dem gewählten Verband. 

Schwierigkeiten: Eckpläne insgesamt, Ecken ragen in die sie bildenden Wände hinein. Diese müssen dementsprechend verkleinert werden.

\subsection{Anwenden der Öffnungen}
Blablabla

\subsection{Anwenden der Mauerwerksverbände}
Ablaufen aller Ecken und Wände und einsetzen der Ziegel gemäß den gefundenen Lösungen.

\subsection{Nachbarschaftsbeziehungen zwischen Bausteinen berechnen}

\subsection{Export}
Abhängigkeitsgraph und Ontologie für Regelwerk



\subsection*{TODOs}
\begin{enumerate}
  \item reduzieren der layer length abhängig vom corner plan
  \item aufteilen der layer bei öffnungen
  \item einpflegen der Dimensionen der Bausteine und Rasterinformationen
\end{enumerate}